<!DOCTYPE html5>
<!-- How to create Mouse Events for D3 -->
<html>

  <head>
    <meta charset="UTF-8">
    <!-- Load D3 from site -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <!-- CSS (Styling) -->
    <style type="text/css">
      body {
        margin: 0;
        font-family: sans-serif;
        font-size: 11px;
        background-color: #EEE9D4;
      }
      .axis path, .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;  /* Round any decimal pixels so it'll render nicely */
      }
      .btn {
        color: #fff;
        margin-right: 4px;
        margin-bottom: 4px;
        font-family: "Avenir Next", serif;
        font-size: 16px;
        font-weight: 400;
        border: 2px;
        border-radius: 30px;
        background: #268BD2;
        text-align: center;
        vertical-align: middle;
        touch-action: manipulation;
        cursor: pointer;
        padding: 10px 20px;

        transition-property: all;
        transition-duration: 0.3s;
        transition-timing-function: ease;
        transition-delay: 0s;
      }


      .dropbtn {
          background-color: #268BD2;
          color: white;
          padding: 16px;
          font-size: 16px;
          border: 2px;
          border-radius: 30px;
          cursor: pointer;
      }
      /* The container <div> - needed to position the dropdown content */
      .dropdown {
          position: relative;
          display: inline-block;

      }
      /* Dropdown Content (Hidden by Default) */
      .dropdown-content {
          display: none;
          position: absolute;
          background-color: #EEE9D4;
          min-width: 160px;
          box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
          z-index: 1;
          border: 2px;
          border-radius: 30px;
      }
      /* Links inside the dropdown */
      .dropdown-content a {
          color: black;
          padding: 12px 16px;
          text-decoration: none;
          display: block;
          border: inherit;
          border-radius: inherit;

      }
      /* Change color of dropdown links on hover */
      .dropdown-content a:hover {background-color: #f1f1f1}
      /* Show the dropdown menu on hover */
      .dropdown:hover .dropdown-content {
          display: block;
      }
      /* Change the background color of the dropdown button when the dropdown content is shown */
      .dropdown:hover .dropbtn {
          background-color: #337ab7;
      }
      /*
      //Can use CSS3 Transitions, but not for everything (e.g. change radius size)
      circle:hover{
        fill: green;
      }
      */
    </style>
  </head>

  <body>
    <button type="button" id="Costarica_Fertility" class="btn">Costa Rica Fertility Rate</button>
    <button type="button" id ="Korea_Fertility" class="btn btn-primary">Korea Fertility Rate</button>
    <button type="button" id ="results" class="btn ">res</button>
    <button type="button" id="clear">Clear</button>
    <button type="button" id="ans">Show Answers</button>
    <div class="dropdown">
      <button class="dropbtn">Dropdown</button>
      <div class="dropdown-content">
        <a href="#costarica">Costa Rica</a>
        <a href="#korea">Korea</a>
      </div>
    </div>
    <!-- Begin Javascript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">
      var oldData = 2015;
      //load csv
      $(document).ready(function() {
        $.ajax({
          type: "GET",
          url: "costarica_converted.csv",
          dataType: "text",
          success: function(costarica){
            plot(costarica);
            data=costarica
          }
        });
      });
      $(document).ready(function() {
        $.ajax({
          type: "GET",
          url: "Korea_Fertility_converted.csv",
          dataType: "text",
          success: function(Korea_Fertility_converted){
            data2=Korea_Fertility_converted
          }
        });
      });

      $(function(){
        $('#Korea_Fertility').on('click', function (e) {
          d3.select("svg").remove();
          oldData = 2015;
          plot(data2)
          });
        });
      $(function(){
        $('#Costarica_Fertility').on('click', function (e) {
          d3.select("svg").remove();
          oldData = 2015;
          plot(data)
          });
        });
      $(function(){
        $('#clear').on('click', function (e) {
          d3.select("svg").remove();
          oldData = 2015;
          plot(data)
          });
        });
      $(function(){
        $('#ans').on('click', function (e) {
		        // Update whether or not the elements are active
            var active   = redLine.active ? false:true ,
  		        newOpacity = active ? 1 : 0;
  		          // Hide or show the elements
  		      d3.select("#redLine").style("opacity", newOpacity);
  		      d3.select("#redAxis").style("opacity", newOpacity);
		          redLine.active = active;
            $.ajax({
              type: "GET",
              url: "user.csv",
              dataType: "text",
              success: function(Korea_Fertility_converted){
                calculate(Korea_Fertility_converted)
              }
            });
          });
        });
      $("div.dropdown-content a").click(function() {
        if (this.href.includes("costarica")) {
          oldData = 2015;
          d3.select("svg").remove();
          plot(data);
        } else {
          oldData = 2015;
          d3.select("svg").remove();
          plot(data2);
        }
      });
      //set margins
      var w = window.innerWidth,
          h = window.innerHeight/2,
          margin = { top: 40, right: 20, bottom: 20, left: 40 },
          radius = 4;


var dataset = [];
    function calculate(data) {
      var data = d3.csv.parse(data);
      console.log("here!");
      var newData = []
      for (var i = 0; i < data.length; i += 1) {
        var j = 0;
        for (j = 0; j < dataset.length; j += 1) {
          //console.log(dataset[j].x +" " + parseFloat(data[i].col1) +" " + (dataset[j].x == parseInt(data[i].col1)))
          if (dataset[j].x == parseInt(data[i].col1)) {
            break;
          }
        }
        //console.log(j);
        var value = 0;
        if (j == dataset.length) {
          value = dataset[j].y;
        } else {
          value = parseFloat(data[i].col2);
        }
        newData.push({"x": data[i].col1, "y": (value + dataset[j].y) / 2.0})
      }
      console.log(newData);
    }

    function plot(data) {
      // read from CSV
      var data = d3.csv.parse(data);
      var answer = [];
      //console.log(data)
      // += 2 is to plot every other data point
      for (var i = 1; i < data.length-2; i += 2) {
        dataset.push({"x": parseInt(data[i].Date), "y": parseFloat(data[i].FertilityRate)});
      }
      for (var i = 55; i < data.length; i += 1) {
        answer.push({"x": parseInt(data[i].Date), "y": parseFloat(data[i].FertilityRate)});
      }
      console.log(answer);
      console.log(dataset);
      var svg = d3.select("body").append("svg").attr({
        width: w,
        height: h,
      });
      // setting x axis boundaries
      var xScale = d3.scale.linear()
          .domain([d3.min(dataset,function (d) {return d.x}), d3.max(dataset, function (d) { return d.x + 10; })])
          .range([margin.left, w- margin.right]);  // Set margins for x specific
      // setting y axis boundaries
      var yScale = d3.scale.linear()
          .domain([0, d3.max(dataset, function (d) { return d.y; })])
          .range([h- margin.top, margin.bottom]);  // Set margins for y specific
      // define an X and Y Axis
      var xAxis = d3.svg.axis().scale(xScale).orient("bottom").tickFormat(d3.format("d"));
      var yAxis = d3.svg.axis().scale(yScale).orient("left");
      var circleAttrs = {
          cx: function(d) { return xScale(d.x); },
          cy: function(d) { return yScale(d.y); },
          r: radius
      };
      // Adds X-Axis as a 'g' element
      svg.append("g").attr({
        "class": "axis",  // Give class so we can style it
        transform: "translate(" + [0,h - 2* margin.bottom] + ")"  // Moves from top of screen to bottom
      }).call(xAxis);  // Call the xAxis function on the group

      // Adds Y-Axis as a 'g' element
      svg.append("g").attr({
        "class": "axis",
        transform: "translate(" + [margin.left, 0] + ")"
      }).call(yAxis);  // Call the yAxis function on the group

      //adds vertical dotted line on 2015
      var x = xScale(2015).toFixed(1);
      var y1 = yScale(0).toFixed(1);
      var y2 = yScale(8.5).toFixed(1);
      svg.append("line")
          .style("stroke", "black")          // attach a line
          .attr("x1", x)                     // x position of the first end of the line
          .attr("y1", y1)                    // y position of the first end of the line
          .attr("x2", x)                     // x position of the second end of the line
          .attr("y2", y2)                    // y position of the second end of the line
          .style("stroke-dasharray", ("3, 3"));     // attach a line

      //draw lines between points
      var x = d3.scale.linear().range([0, w]);
      var y = d3.scale.linear().range([h, 0]);
      var linefunction = d3.svg.line()
          .x(function(d) { return xScale(d.x); })
          .y(function(d) { return yScale(d.y); })
          .interpolate("linear");
      var path;
      path = svg.append("path")
          .attr("d", linefunction(dataset))
          .attr("stroke", "blue")
          .attr("stroke-width", 2)
          .attr("fill", "none");
      //updates initial circles
      svg.selectAll("circle")
          .data(dataset)
          .enter()
          .append("circle")
          .attr(circleAttrs)  // Get attributes from circleAttrs var
          .on("mouseover", handleMouseOver)
          .on("mouseout", handleMouseOut);
var active;
      svg.append("path")
          .attr("d", linefunction(answer))
          .attr("stroke", "red")
          .attr("stroke-width", 2)
          .attr("fill", "none")
          .attr("id", "redLine")
          .attr("opacity", 0);

//WIP currently breaks click functionality
      //on mousemove, there should be a line from the last point to the mouse cursor
      // svg.on('mousemove', function() {
      //     svg.append("path")
      //       .attr("d", linefunction(mousemove))
      //       .attr("stroke", "black")
      //       .attr("stroke-width", 2)
      //       .attr("fill", "none");
      //     })
      // var mouse_line = d3.svg.line()
      //   var coords=[0,0]
      //   coords = d3.mouse(this)
      //   var x = coords[0];
      //   var y = coords[1];
      //   var hovermouse = [
      //     {"x":x,"y":y},{"x":dataset[dataset.length - 1].x,"y":dataset[dataset.length - 1].y},
      //   ];
        // On Click, we want to add data to the array and chart. Points are added for integer year values
      svg.on("click", function() {
          var coords = d3.mouse(this);
          // Normally we go from data to pixels, but here we're doing pixels to data
          var newData= {
            "x": Math.round( xScale.invert(coords[0])),  // Takes the pixel number to convert to coordinate
            "y": d3.format(".2f")( yScale.invert(coords[1]))
          };
          newData.y = parseFloat(newData.y);
          if (newData.y > 0 && newData.x > 2015 && newData.x % 2 == 1 ) {
            var x = 0;
            for (var i = 0; i < dataset.length; i += 1) {
              if (dataset[i].x == newData.x) {
                x = i;
                dataset[i] = newData;
              }
            }
            if (newData.x > oldData) {
              dataset.push(newData);   // Push data to our dataset array
              oldData = newData.x;
              console.log(oldData);
              console.log(dataset);
            } else {
              temp = [];
              temp.push(dataset[0])
              for (var i = 1; i < dataset.length; i += 1) {
                if (newData.x >= dataset[i - 1].x && newData.x <= dataset[i].x) {
                  temp.push(newData);
                }
                temp.push(dataset[i])
              }
              dataset = temp;
            }
            d3.selectAll("circle").remove();
            d3.selectAll("path").remove();

            // define an X and Y Axis
            var xAxis = d3.svg.axis().scale(xScale).orient("bottom").tickFormat(d3.format("d"));
            var yAxis = d3.svg.axis().scale(yScale).orient("left");
            // Adds X-Axis as a 'g' element
            svg.append("g").attr({
              "class": "axis",  // Give class so we can style it
              transform: "translate(" + [0,h - 2* margin.bottom] + ")"  // Moves from top of screen to bottom
            }).call(xAxis);  // Call the xAxis function on the group

            // Adds Y-Axis as a 'g' element
            svg.append("g").attr({
              "class": "axis",
              transform: "translate(" + [margin.left, 0] + ")"
            }).call(yAxis);  // Call the yAxis function on the group


            path = svg.append("path")
               //make the connecting line
              .attr("d", linefunction(dataset))
              .attr("stroke", "blue")
              .attr("stroke-width", 2)
              .attr("fill", "none");
              svg.append("path")
                  .attr("d", linefunction(answer))
                  .attr("stroke", "red")
                  .attr("stroke-width", 2)
                  .attr("fill", "none")
                  .attr("id", "redLine")
                  .attr("opacity", 0);
                  svg.selectAll("circle")
                     // For new circle, go through the update process
                    .data(dataset)
                    .enter()
                    .append("circle")
                    .attr(circleAttrs)  // Get attributes from circleAttrs var
                    .on("mouseover", handleMouseOver)
                    .on("mouseout", handleMouseOut);
          }
        })
      // Create Event Handlers for mouse
      function handleMouseOver(d, i) {  // Add interactivity
            // Use D3 to select element, change color and size
            d3.select(this).attr({
              fill: "blue",
              r: radius * 1.5
            });
            // Specify where to put label of text
            svg.append("text").attr({
               id: "t" + d.x + "-" + d.y + "-" + i,  // Create an id for text so we can select it later for removing on mouseout
                x: function() { return xScale(d.x) + 5; },
                y: function() { return yScale(d.y) - 15; }
            })
            .text(function() {
              return [d.x, d.y];  // Value of the text
            });
          }
      function handleMouseOut(d, i) {
            // Use D3 to select element, change color back to normal
            d3.select(this).attr({
              fill: "black",
              r: radius
            });
            // Select text by id and then remove. this part works for user plotted points but not dataset points right now. idk why it got buggy
            x = document.getElementById("t" + d.x + "-" + d.y + "-"+ i);
            x.remove();
          }
        }
    </script>
  </body>
</html>
